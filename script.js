const localStorageTheme = localStorage.getItem("theme");
const systemSettingDark = window.matchMedia("(prefers-color-scheme: dark)");

function calculateSettingAsThemeString({ localStorageTheme, systemSettingDark }) {
    if (localStorageTheme !== null) {
        return localStorageTheme;
    }
    return systemSettingDark.matches ? "dark" : "light";
}

let currentThemeSetting = calculateSettingAsThemeString({ 
    localStorageTheme, 
    systemSettingDark 
});

document.querySelector("html").setAttribute("data-theme", currentThemeSetting);

const button = document.querySelector("[data-theme-toggle]");
if (button) {
    const sunIcon = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M13.5451 6.45499C12.6456 5.55552 11.3757 4.97351 10.0001 4.97351C8.62443 4.97351 7.35459 5.52907 6.45511 6.45499C5.55564 7.35446 4.97363 8.6243 4.97363 9.99997C4.97363 11.3756 5.55564 12.6455 6.45511 13.5449C7.35459 14.4444 8.62443 15.0264 10.0001 15.0264C11.3757 15.0264 12.6456 14.4709 13.5451 13.5449C14.4445 12.6455 15.0265 11.3756 15.0265 9.99997C15.0265 8.6243 14.471 7.35446 13.5451 6.45499Z" fill="currentColor" />
        <path d="M9.99984 3.4127C10.3702 3.4127 10.6877 3.09524 10.6877 2.72487V0.687831C10.6877 0.31746 10.3702 0 9.99984 0C9.62947 0 9.31201 0.31746 9.31201 0.687831V2.72487C9.31201 3.09524 9.62947 3.4127 9.99984 3.4127Z" fill="currentColor" />
        <path d="M15.6347 5.34386L17.0897 3.88883C17.3543 3.62428 17.3543 3.201 17.0897 2.93645C16.8252 2.6719 16.4019 2.6719 16.1373 2.93645L14.6823 4.39148C14.4177 4.65603 14.4177 5.07931 14.6823 5.34386C14.9204 5.60841 15.3437 5.60841 15.6347 5.34386Z" fill="currentColor" />
        <path d="M19.3123 9.31213H17.2752C16.9049 9.31213 16.5874 9.62959 16.5874 9.99996C16.5874 10.3703 16.9049 10.6878 17.2752 10.6878H19.3123C19.6826 10.6878 20.0001 10.3703 20.0001 9.99996C20.0001 9.62959 19.6826 9.31213 19.3123 9.31213Z" fill="currentColor" />
        <path d="M15.6083 14.6561C15.3438 14.3915 14.9205 14.3915 14.6559 14.6561C14.3914 14.9206 14.3914 15.3439 14.6559 15.6084L16.111 17.0635C16.3755 17.328 16.7988 17.328 17.0633 17.0635C17.3279 16.7989 17.3279 16.3756 17.0633 16.1111L15.6083 14.6561Z" fill="currentColor" />
        <path d="M9.99984 16.5873C9.62947 16.5873 9.31201 16.9047 9.31201 17.2751V19.3121C9.31201 19.6825 9.62947 20 9.99984 20C10.3702 20 10.6877 19.6825 10.6877 19.3121V17.2751C10.6877 16.9047 10.3702 16.5873 9.99984 16.5873Z" fill="currentColor" />
        <path d="M4.36486 14.6561L2.90984 16.1111C2.64529 16.3756 2.64529 16.7989 2.90984 17.0635C3.17439 17.328 3.59767 17.328 3.86222 17.0635L5.31725 15.6084C5.5818 15.3439 5.5818 14.9206 5.31725 14.6561C5.07915 14.3915 4.65587 14.3915 4.36486 14.6561Z" fill="currentColor" />
        <path d="M3.4127 9.99996C3.4127 9.62959 3.09524 9.31213 2.72487 9.31213H0.687831C0.31746 9.31213 0 9.62959 0 9.99996C0 10.3703 0.31746 10.6878 0.687831 10.6878H2.72487C3.09524 10.6878 3.4127 10.3703 3.4127 9.99996Z" fill="currentColor" />
        <path d="M4.36486 5.34386C4.62942 5.60841 5.0527 5.60841 5.31725 5.34386C5.5818 5.07931 5.5818 4.65603 5.31725 4.39148L3.86222 2.93645C3.59767 2.6719 3.17439 2.6719 2.90984 2.93645C2.64529 3.201 2.64529 3.62428 2.90984 3.88883L4.36486 5.34386Z" fill="currentColor" />
    </svg>`;

    const moonIcon = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M19.5133 11.3967C19.3087 11.3453 19.1041 11.3966 18.9251 11.5251C18.2602 12.0901 17.4929 12.5523 16.649 12.8605C15.8562 13.1687 14.9866 13.3228 14.066 13.3228C11.9944 13.3228 10.1019 12.4753 8.74647 11.1142C7.39102 9.75303 6.54707 7.85258 6.54707 5.77237C6.54707 4.89919 6.70051 4.0517 6.95626 3.28125C7.23758 2.45944 7.64677 1.71467 8.18383 1.07263C8.414 0.790132 8.36285 0.379226 8.08153 0.148091C7.90251 0.0196826 7.69792 -0.0316807 7.49332 0.0196826C5.31949 0.61036 3.42698 1.92012 2.07153 3.66648C0.767234 5.38715 0 7.51872 0 9.83007C0 12.6294 1.12528 15.1719 2.96664 17.0209C4.808 18.87 7.3143 20 10.1275 20C12.4803 20 14.6542 19.1782 16.3932 17.8171C18.1579 16.4303 19.4366 14.4528 19.9737 12.1928C20.076 11.8332 19.8714 11.4737 19.5133 11.3967Z" fill="currentColor" />
    </svg>`;

    function updateButtonContent(theme) {
        const text = theme === "dark" ? "LIGHT" : "DARK";
        const icon = theme === "dark" ? sunIcon : moonIcon; 
        
        button.innerHTML = icon + text;
        button.setAttribute("aria-label", `Switch to ${text} theme`);
        
        button.style.display = "inline-flex";
        button.style.alignItems = "center";
        button.style.justifyContent = "center";
        button.style.gap = "8px"; 
    }

    updateButtonContent(currentThemeSetting);

    button.addEventListener("click", () => {
        const newTheme = currentThemeSetting === "dark" ? "light" : "dark";
        currentThemeSetting = newTheme;
        
        updateButtonContent(newTheme);
        document.querySelector("html").setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
    });
}

systemSettingDark.addEventListener('change', (e) => {
    if (!localStorage.getItem("theme")) { 
        const newSystemTheme = e.matches ? "dark" : "light";
        document.querySelector("html").setAttribute("data-theme", newSystemTheme);
        currentThemeSetting = newSystemTheme;
        
        if (button) {
            updateButtonContent(newSystemTheme);
        }
    }
});